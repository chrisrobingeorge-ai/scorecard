# overall_scorecard_app.py
#
# Purpose:
#   Take the department scorecard PDFs from the Monthly Scorecard app,
#   extract their embedded JSON, and generate inputs for a single
#   organisation-wide narrative report for the Board.
#
#   This app:
#   - Shows a simple table of which departments/months you’ve loaded
#   - Builds a rich, combined prompt from all departmental summaries
#   - (Optionally) can be wired to your OpenAI client / ai_utils

from __future__ import annotations

import json
from typing import Dict, Any, List

import pandas as pd
import streamlit as st
from PyPDF2 import PdfReader

JSON_PREFIX = "AB_SCORECARD_JSON:"

# ─────────────────────────────────────────────────────────────────────────────
# Streamlit page config
# ─────────────────────────────────────────────────────────────────────────────
st.set_page_config(page_title="Overall Monthly Scorecard – Board Report", layout="wide")

st.title("Overall Monthly Scorecard – Board Narrative")

st.write(
    """
Upload the **department scorecard PDFs** generated by the Monthly Scorecard app.  
This helper will extract their embedded summaries and build a single, combined
narrative input for your Board report.
"""
)

# ─────────────────────────────────────────────────────────────────────────────
# Helper: extract a structured summary from one payload
# ─────────────────────────────────────────────────────────────────────────────
def extract_department_summary(
    payload: Dict[str, Any],
    source_name: str,
) -> Dict[str, Any]:
    """
    Take the JSON payload embedded in a scorecard PDF and distill the
    key bits we need for an organisation-wide narrative.

    We intentionally keep this simple:
    - Which department and month?
    - What is the overall score?
    - What are the pillar scores (if present)?
    - What is the department-level AI summary text?
    """
    meta = payload.get("meta", {}) or {}
    scores = payload.get("scores", {}) or {}
    ai_interp = payload.get("ai_interpretation", {}) or {}
    questions = payload.get("questions", []) or []

    department = meta.get("department") or meta.get("dept_label") or ""
    month = meta.get("month")
    month_label = meta.get("month_label") or month
    production = meta.get("production") or meta.get("programme") or ""
    staff_name = meta.get("staff_name") or ""
    role = meta.get("role") or ""

    overall_score = scores.get("overall_score")
    pillar_scores = scores.get("pillar_scores") or {}

    summary_text = ai_interp.get("overall_summary") or ""

    return {
        "source_file": source_name,
        "department": department,
        "month": month,
        "month_label": month_label,
        "overall_score": overall_score,
        "pillar_scores": pillar_scores,
        "production": production,
        "staff_name": staff_name,
        "role": role,
        "num_questions": len(questions),
        "summary_text": summary_text,
    }


# ─────────────────────────────────────────────────────────────────────────────
# 1. Upload PDFs
# ─────────────────────────────────────────────────────────────────────────────
uploaded_files = st.file_uploader(
    "Upload department scorecard PDFs (you can select multiple)",
    type=["pdf"],
    accept_multiple_files=True,
)

if not uploaded_files:
    st.stop()

# ─────────────────────────────────────────────────────────────────────────────
# 2. Extract JSON from each PDF and build department summaries
# ─────────────────────────────────────────────────────────────────────────────
dept_summaries: List[Dict[str, Any]] = []
skipped_files: List[str] = []

for f in uploaded_files:
    try:
        reader = PdfReader(f)
    except Exception:
        skipped_files.append(f.name)
        continue

    info = reader.metadata or {}
    subject = getattr(info, "subject", None) or info.get("/Subject") or ""

    if not subject or JSON_PREFIX not in subject:
        skipped_files.append(f.name)
        continue

    try:
        _, json_str = subject.split(JSON_PREFIX, 1)
        payload = json.loads(json_str)
    except Exception:
        skipped_files.append(f.name)
        continue

    dept_summary = extract_department_summary(payload, f.name)
    dept_summaries.append(dept_summary)

if not dept_summaries:
    st.error("No usable embedded scorecard data found in the uploaded PDFs.")
    if skipped_files:
        st.info("Files skipped (no or invalid embedded JSON): " + ", ".join(skipped_files))
    st.stop()

if skipped_files:
    st.warning(
        "Some files were skipped because they did not contain embedded scorecard data: "
        + ", ".join(skipped_files)
    )

# ─────────────────────────────────────────────────────────────────────────────
# 3. Sanity table – what did we load?
# ─────────────────────────────────────────────────────────────────────────────
df_overview = pd.DataFrame(
    [
        {
            "source_file": ds["source_file"],
            "department": ds["department"],
            "month_label": ds["month_label"],
            "overall_score": ds["overall_score"],
            "num_questions": ds["num_questions"],
        }
        for ds in dept_summaries
    ]
)

st.subheader("Loaded department scorecards")
st.dataframe(df_overview, use_container_width=True)

# ─────────────────────────────────────────────────────────────────────────────
# Helper: build a single prompt for the overall AI narrative
# ─────────────────────────────────────────────────────────────────────────────
def build_overall_prompt(dept_summaries: List[Dict[str, Any]]) -> str:
    """
    Construct a rich text prompt that you can feed to an LLM to generate
    an organisation-wide Board report.

    We keep the structure consistent so the model can reason across departments.
    """

    header = (
        "You are preparing a monthly organisational report for the Board of Alberta Ballet.\n"
        "You will receive department-level scorecard summaries, each with:\n"
        "- Department name\n"
        "- Reporting month\n"
        "- Overall 0–3 score (higher is better)\n"
        "- Any available pillar scores (0–3)\n"
        "- A narrative summary produced from that department's detailed scorecard responses\n\n"
        "Using these inputs, write a single, integrated narrative report that:\n"
        "1. Summarises overall organisational performance this month, referencing departments by name.\n"
        "2. Comments on progress against major strategic aims (e.g., artistic excellence, community impact,\n"
        "   financial resilience, talent development), based on what you can infer from the departmental summaries.\n"
        "3. Identifies cross-cutting risks, tensions, or capacity constraints that the Board should be aware of.\n"
        "4. Highlights notable strengths, achievements, or momentum.\n"
        "5. Recommends 3–6 organisation-wide priorities for the next reporting period, phrased as clear actions\n"
        "   (e.g., 'Consolidate…', 'Invest further in…', 'Stabilise…').\n\n"
        "Write in a formal, board-facing tone (not academic, not marketing copy). Assume the Board already knows\n"
        "the organisation well; you don't need to reintroduce Alberta Ballet, only to interpret this month's results.\n\n"
        "Here are the department summaries:\n"
        "────────────────────────────────────────────────────────\n\n"
    )

    blocks: List[str] = []

    # Group by month label to keep temporal context clear
    # (if multiple months are ever uploaded together).
    for ds in dept_summaries:
        dept = ds["department"] or "Unknown department"
        month_label = ds["month_label"] or (ds["month"] or "Reporting period not specified")
        overall_score = ds["overall_score"]
        pillar_scores = ds["pillar_scores"] or {}
        summary_text = ds["summary_text"] or ""

        # Format pillar scores as a compact bullet list, if present
        if pillar_scores:
            pillar_lines = [
                f"- {name}: {val:.2f} / 3"
                for name, val in pillar_scores.items()
                if isinstance(val, (int, float))
            ]
            pillar_block = "\n".join(pillar_lines)
        else:
            pillar_block = "(No explicit pillar scores provided.)"

        block = (
            f"=== Department: {dept} ===\n"
            f"Reporting period: {month_label}\n"
            f"Overall score: {overall_score if overall_score is not None else 'N/A'} / 3\n"
            f"Pillar scores:\n{pillar_block}\n\n"
            f"Department summary:\n{summary_text.strip() or '[No summary text provided]'}\n"
            "────────────────────────────────────────────────────────\n"
        )
        blocks.append(block)

    return header + "\n".join(blocks)


# ─────────────────────────────────────────────────────────────────────────────
# 4. Build and (optionally) send the prompt to an AI
# ─────────────────────────────────────────────────────────────────────────────
st.subheader("Board narrative – AI input")

overall_prompt = build_overall_prompt(dept_summaries)

with st.expander("Show/hide combined AI prompt (you can copy–paste this into ChatGPT)", expanded=False):
    st.code(overall_prompt, language="markdown")

st.write(
    """
You can either:

- **Copy this prompt** and paste it into ChatGPT (or another LLM) to generate your Board report, or
- Wire this app to your existing OpenAI/`ai_utils` setup to generate the report directly below.
"""
)

# Optional: placeholder button to integrate with your own AI client.
# For now, we just echo the prompt structure so you can plug it into ai_utils
# if you wish (similar to interpret_scorecard).

if st.button("Generate Board Narrative (placeholder)"):
    st.info(
        "This button is a placeholder. To generate the narrative automatically, "
        "replace this block with a call to your OpenAI client or ai_utils, e.g. "
        "`interpret_overall_scorecards(overall_prompt)` and display the result below."
    )
    st.write("For now, copy the prompt above into ChatGPT to get your Board report.")
